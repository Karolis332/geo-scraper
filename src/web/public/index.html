<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>geo-scraper — Dashboard</title>
<style>
  :root {
    --bg: #0a0a0a; --surface: #141414; --surface2: #1e1e1e;
    --border: #2a2a2a; --text: #e5e5e5; --text-dim: #888;
    --accent: #6366f1; --accent-hover: #818cf8;
    --green: #22c55e; --yellow: #eab308; --red: #ef4444;
    --radius: 8px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
  a { color: var(--accent); text-decoration: none; }
  a:hover { color: var(--accent-hover); }
  button { cursor: pointer; font-family: inherit; font-size: 14px; }
  input, select { font-family: inherit; font-size: 14px; }

  /* Header */
  .header { padding: 20px 32px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 32px; }
  .header h1 { font-size: 20px; font-weight: 700; color: var(--accent); }
  .nav { display: flex; gap: 4px; }
  .nav button { background: none; border: 1px solid transparent; color: var(--text-dim); padding: 8px 16px; border-radius: var(--radius); transition: all 0.15s; }
  .nav button:hover { color: var(--text); background: var(--surface); }
  .nav button.active { color: var(--text); background: var(--surface2); border-color: var(--border); }

  /* Container */
  .container { max-width: 900px; margin: 0 auto; padding: 32px; }

  /* Views */
  .view { display: none; }
  .view.active { display: block; }

  /* New Scan Form */
  .form-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 13px; color: var(--text-dim); margin-bottom: 6px; }
  .form-group input { width: 100%; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 10px 14px; border-radius: var(--radius); outline: none; }
  .form-group input:focus { border-color: var(--accent); }
  .form-row { display: flex; gap: 16px; }
  .form-row .form-group { flex: 1; }
  .form-actions { display: flex; gap: 12px; margin-top: 20px; }
  .btn { padding: 10px 20px; border-radius: var(--radius); border: 1px solid var(--border); font-weight: 500; transition: all 0.15s; }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-secondary { background: var(--surface2); color: var(--text); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: transparent; border-color: var(--red); color: var(--red); padding: 4px 10px; font-size: 12px; }
  .btn-danger:hover { background: var(--red); color: white; }
  .btn-sm { padding: 6px 12px; font-size: 13px; }

  /* Progress */
  .progress-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-top: 24px; }
  .progress-stage { font-size: 14px; color: var(--text-dim); margin-bottom: 12px; }
  .progress-bar-outer { background: var(--surface2); border-radius: 4px; height: 8px; overflow: hidden; }
  .progress-bar-inner { background: var(--accent); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 4px; }
  .progress-msg { font-size: 13px; color: var(--text-dim); margin-top: 10px; min-height: 20px; }

  /* Score Card */
  .score-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 32px; text-align: center; margin-top: 24px; }
  .score-big { font-size: 64px; font-weight: 800; line-height: 1; }
  .score-big .grade { font-size: 32px; font-weight: 600; margin-left: 8px; }
  .score-label { font-size: 14px; color: var(--text-dim); margin-top: 8px; }
  .score-green { color: var(--green); }
  .score-yellow { color: var(--yellow); }
  .score-red { color: var(--red); }

  /* Detail tables */
  .detail-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  .detail-table th { text-align: left; font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px; border-bottom: 1px solid var(--border); }
  .detail-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
  .detail-table tr:last-child td { border-bottom: none; }
  .status-pass { color: var(--green); }
  .status-partial { color: var(--yellow); }
  .status-fail { color: var(--red); }

  .result-actions { display: flex; gap: 12px; margin-top: 20px; justify-content: center; }

  /* History */
  .history-table { width: 100%; border-collapse: collapse; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
  .history-table th { text-align: left; font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; padding: 12px 16px; background: var(--surface2); border-bottom: 1px solid var(--border); }
  .history-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
  .history-table tr:last-child td { border-bottom: none; }
  .history-table tbody tr { cursor: pointer; transition: background 0.1s; }
  .history-table tbody tr:hover { background: var(--surface2); }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
  .badge-scan { background: rgba(99,102,241,0.15); color: var(--accent); }
  .badge-check { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-running { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .badge-failed { background: rgba(239,68,68,0.15); color: var(--red); }
  .empty-state { text-align: center; padding: 48px 24px; color: var(--text-dim); }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; width: 600px; max-width: 90vw; max-height: 80vh; overflow-y: auto; }
  .modal h3 { margin-bottom: 16px; }
  .modal-close { float: right; background: none; border: none; color: var(--text-dim); font-size: 20px; cursor: pointer; }
  .file-list { list-style: none; }
  .file-list li { padding: 8px 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
  .file-list li:last-child { border-bottom: none; }
</style>
</head>
<body>

<div class="header">
  <h1>geo-scraper</h1>
  <div class="nav">
    <button class="active" onclick="showView('scan')">New Scan</button>
    <button onclick="showView('history')">History</button>
  </div>
</div>

<div class="container">
  <!-- NEW SCAN VIEW -->
  <div id="view-scan" class="view active">
    <div class="form-card">
      <div class="form-group">
        <label>Website URL</label>
        <input type="text" id="url-input" placeholder="https://example.com" autofocus>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Max Pages</label>
          <input type="number" id="max-pages" value="50" min="1" max="500">
        </div>
        <div class="form-group">
          <label>Query Count (check only)</label>
          <input type="number" id="query-count" value="10" min="1" max="50">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="startJob('scan')">Scan</button>
        <button class="btn btn-secondary" onclick="startJob('check')">Check Visibility</button>
      </div>
    </div>

    <!-- Progress (hidden until a job starts) -->
    <div id="progress-card" class="progress-card" style="display:none">
      <div class="progress-stage" id="progress-stage">Starting...</div>
      <div class="progress-bar-outer">
        <div class="progress-bar-inner" id="progress-bar"></div>
      </div>
      <div class="progress-msg" id="progress-msg"></div>
    </div>

    <!-- Results (hidden until job completes) -->
    <div id="result-card" style="display:none">
      <div class="score-card">
        <div class="score-big" id="result-score"></div>
        <div class="score-label" id="result-label"></div>
      </div>
      <table class="detail-table" id="result-table"></table>
      <div class="result-actions">
        <button class="btn btn-primary btn-sm" id="btn-report" onclick="viewReport()">View Report</button>
        <button class="btn btn-secondary btn-sm" id="btn-report-pdf" onclick="viewReport('pdf')" title="Export report as PDF">PDF</button>
        <button class="btn btn-secondary btn-sm" id="btn-report-csv" onclick="viewReport('csv')" title="Export report as CSV">CSV</button>
        <button class="btn btn-primary btn-sm" id="btn-comparison" style="display:none;background:#22c55e;border-color:#22c55e" onclick="viewComparison()">Before / After</button>
        <button class="btn btn-secondary btn-sm" id="btn-comparison-pdf" style="display:none" onclick="viewComparison('pdf')" title="Export comparison as PDF">PDF</button>
        <button class="btn btn-secondary btn-sm" id="btn-comparison-csv" style="display:none" onclick="viewComparison('csv')" title="Export comparison as CSV">CSV</button>
        <button class="btn btn-secondary btn-sm" id="btn-files" onclick="viewFiles()">Browse Files</button>
        <button class="btn btn-secondary btn-sm" onclick="resetForm()">New Scan</button>
      </div>
    </div>
  </div>

  <!-- HISTORY VIEW -->
  <div id="view-history" class="view">
    <div id="history-content"></div>
  </div>
</div>

<!-- Files Modal -->
<div class="modal-overlay" id="files-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <h3>Generated Files</h3>
    <ul class="file-list" id="file-list"></ul>
  </div>
</div>

<script>
  let currentJobId = null;
  let currentJobType = null;
  let eventSource = null;

  // ── Navigation ─────────────────────────────────────────────────
  function showView(name) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    document.getElementById('view-' + name).classList.add('active');
    document.querySelectorAll('.nav button')[name === 'scan' ? 0 : 1].classList.add('active');
    if (name === 'history') loadHistory();
  }

  // ── Start Job ──────────────────────────────────────────────────
  async function startJob(type) {
    const url = document.getElementById('url-input').value.trim();
    if (!url) { document.getElementById('url-input').focus(); return; }

    const maxPages = parseInt(document.getElementById('max-pages').value) || 50;
    const queryCount = parseInt(document.getElementById('query-count').value) || 10;

    const body = { url, maxPages, concurrency: 3 };
    if (type === 'check') body.queryCount = queryCount;

    // Show progress, hide results
    document.getElementById('progress-card').style.display = 'block';
    document.getElementById('result-card').style.display = 'none';
    document.getElementById('progress-stage').textContent = 'Starting...';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-msg').textContent = '';

    try {
      const res = await fetch('/api/' + type, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      if (!res.ok) {
        document.getElementById('progress-stage').textContent = 'Error: ' + (data.error || 'Unknown');
        return;
      }
      currentJobId = data.jobId;
      currentJobType = type;
      connectSSE(data.jobId);
    } catch (err) {
      document.getElementById('progress-stage').textContent = 'Error: ' + err.message;
    }
  }

  // ── SSE Progress ───────────────────────────────────────────────
  function connectSSE(jobId) {
    if (eventSource) eventSource.close();
    eventSource = new EventSource('/api/jobs/' + jobId + '/progress');

    eventSource.onmessage = (e) => {
      const data = JSON.parse(e.data);
      document.getElementById('progress-stage').textContent = capitalize(data.stage);
      document.getElementById('progress-bar').style.width = data.percent + '%';
      document.getElementById('progress-msg').textContent = data.message;

      if (data.stage === 'done') {
        eventSource.close();
        eventSource = null;
        loadResults(jobId);
      }
      if (data.stage === 'error') {
        eventSource.close();
        eventSource = null;
        document.getElementById('progress-stage').textContent = 'Failed';
        document.getElementById('progress-msg').textContent = data.message;
        document.getElementById('progress-bar').style.width = '100%';
        document.getElementById('progress-bar').style.background = 'var(--red)';
      }
    };

    eventSource.onerror = () => {
      eventSource.close();
      eventSource = null;
      // Poll for completion instead
      setTimeout(() => pollJob(jobId), 1000);
    };
  }

  async function pollJob(jobId) {
    try {
      const res = await fetch('/api/jobs/' + jobId);
      const job = await res.json();
      if (job.status === 'completed') {
        loadResults(jobId);
      } else if (job.status === 'failed') {
        document.getElementById('progress-stage').textContent = 'Failed';
        document.getElementById('progress-msg').textContent = job.error || 'Unknown error';
      } else {
        setTimeout(() => pollJob(jobId), 2000);
      }
    } catch { /* ignore */ }
  }

  // ── Load Results ───────────────────────────────────────────────
  async function loadResults(jobId) {
    const res = await fetch('/api/jobs/' + jobId);
    const job = await res.json();

    document.getElementById('progress-card').style.display = 'none';
    document.getElementById('result-card').style.display = 'block';

    const score = job.score || 0;
    const grade = job.grade || '?';
    const colorClass = score >= 70 ? 'score-green' : score >= 40 ? 'score-yellow' : 'score-red';

    document.getElementById('result-score').innerHTML =
      `<span class="${colorClass}">${score}<span class="grade">${grade}</span></span>`;
    document.getElementById('result-label').textContent =
      job.type === 'scan' ? 'GEO Compliance Score' : 'AI Visibility Score';

    // Show comparison button only for scan jobs
    const isScan = job.type === 'scan';
    document.getElementById('btn-comparison').style.display = isScan ? '' : 'none';
    document.getElementById('btn-comparison-pdf').style.display = isScan ? '' : 'none';
    document.getElementById('btn-comparison-csv').style.display = isScan ? '' : 'none';

    // Render detail table
    const table = document.getElementById('result-table');
    const result = job.result;

    if (result && result.type === 'scan' && result.auditItems) {
      table.innerHTML = `<thead><tr><th>Item</th><th>Category</th><th>Score</th><th>Status</th></tr></thead><tbody>` +
        result.auditItems.map(item =>
          `<tr><td>${esc(item.name)}</td><td>${esc(item.category)}</td>` +
          `<td>${item.score}/${item.maxScore}</td>` +
          `<td class="status-${item.status}">${item.status}</td></tr>`
        ).join('') + `</tbody>`;
    } else if (result && result.type === 'check' && result.engineScores) {
      table.innerHTML = `<thead><tr><th>Engine</th><th>Cited</th><th>Mentioned</th><th>Absent</th><th>Score</th></tr></thead><tbody>` +
        result.engineScores.map(es =>
          `<tr><td>${capitalize(esc(es.engine))}</td>` +
          `<td class="status-pass">${es.cited}</td>` +
          `<td class="status-partial">${es.mentioned}</td>` +
          `<td class="status-fail">${es.absent}</td>` +
          `<td>${es.score}/100</td></tr>`
        ).join('') + `</tbody>`;
    } else {
      table.innerHTML = '';
    }

    currentJobId = jobId;
    currentJobType = job.type;
  }

  // ── Report & Files ─────────────────────────────────────────────
  function viewReport(exportType) {
    if (!currentJobId) return;
    const suffix = exportType ? '?export=' + exportType : '';
    window.open('/api/jobs/' + currentJobId + '/report' + suffix, '_blank');
  }

  function viewComparison(exportType) {
    if (!currentJobId) return;
    const suffix = exportType ? '?export=' + exportType : '';
    window.open('/api/jobs/' + currentJobId + '/comparison' + suffix, '_blank');
  }

  async function viewFiles() {
    if (!currentJobId) return;
    const res = await fetch('/api/jobs/' + currentJobId + '/files');
    const files = await res.json();

    const list = document.getElementById('file-list');
    if (files.length === 0) {
      list.innerHTML = '<li style="color:var(--text-dim)">No files generated yet</li>';
    } else {
      list.innerHTML = files.map(f =>
        `<li><span>${esc(f)}</span><a href="/api/jobs/${currentJobId}/files/${encodeURIComponent(f)}" target="_blank">View</a></li>`
      ).join('');
    }
    document.getElementById('files-modal').classList.add('open');
  }

  function closeModal() {
    document.getElementById('files-modal').classList.remove('open');
  }

  // ── History ────────────────────────────────────────────────────
  async function loadHistory() {
    const res = await fetch('/api/jobs');
    const jobs = await res.json();

    const el = document.getElementById('history-content');
    if (jobs.length === 0) {
      el.innerHTML = '<div class="empty-state">No jobs yet. Run a scan to get started.</div>';
      return;
    }

    el.innerHTML = `<table class="history-table">
      <thead><tr><th>Date</th><th>URL</th><th>Type</th><th>Score</th><th>Status</th><th></th></tr></thead>
      <tbody>` + jobs.map(j => {
        const date = new Date(j.created_at).toLocaleString();
        const score = j.score != null ? j.score + '/100' : '—';
        const grade = j.grade || '';
        const statusBadge = j.status === 'running' ? '<span class="badge badge-running">Running</span>'
          : j.status === 'failed' ? '<span class="badge badge-failed">Failed</span>'
          : '';
        const colorClass = (j.score || 0) >= 70 ? 'score-green' : (j.score || 0) >= 40 ? 'score-yellow' : 'score-red';
        return `<tr onclick="viewHistoryJob('${j.id}')">
          <td style="color:var(--text-dim);font-size:13px">${esc(date)}</td>
          <td>${esc(j.url)}</td>
          <td><span class="badge badge-${j.type}">${j.type}</span></td>
          <td class="${j.score != null ? colorClass : ''}">${score} ${grade}</td>
          <td>${statusBadge || (j.status === 'completed' ? '<span style="color:var(--green)">Done</span>' : j.status)}</td>
          <td><button class="btn btn-danger" onclick="event.stopPropagation();deleteJob('${j.id}')">Delete</button></td>
        </tr>`;
      }).join('') + `</tbody></table>`;
  }

  async function viewHistoryJob(jobId) {
    showView('scan');
    document.getElementById('progress-card').style.display = 'none';

    const res = await fetch('/api/jobs/' + jobId);
    const job = await res.json();

    if (job.status === 'completed') {
      currentJobId = jobId;
      currentJobType = job.type;
      document.getElementById('url-input').value = job.url;
      await loadResults(jobId);
    } else if (job.status === 'running') {
      currentJobId = jobId;
      currentJobType = job.type;
      document.getElementById('url-input').value = job.url;
      document.getElementById('progress-card').style.display = 'block';
      document.getElementById('result-card').style.display = 'none';
      connectSSE(jobId);
    }
  }

  async function deleteJob(jobId) {
    await fetch('/api/jobs/' + jobId, { method: 'DELETE' });
    loadHistory();
  }

  function resetForm() {
    document.getElementById('progress-card').style.display = 'none';
    document.getElementById('result-card').style.display = 'none';
    document.getElementById('progress-bar').style.background = 'var(--accent)';
    document.getElementById('url-input').value = '';
    document.getElementById('url-input').focus();
    currentJobId = null;
    currentJobType = null;
  }

  // ── Helpers ────────────────────────────────────────────────────
  function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }
  function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

  // Handle Enter key on URL input
  document.getElementById('url-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') startJob('scan');
  });

  // Close modal on overlay click
  document.getElementById('files-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeModal();
  });
</script>
</body>
</html>
